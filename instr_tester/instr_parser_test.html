<!DOCTYPE html>
<html>
  <head>
    <title>Read File (via User Input selection)</title>
    <script src="js/nebInstrParser.js"></script>
    <script type="text/javascript">
    var reader; //GLOBAL File Reader object for demo purpose only
    var parser; // GLOBAL Parser probably should go elsewhere...
    /**
     * Check for the various File API support.
     */
    function onPageLoad() {
        parser = new nebInstrParser();
        checkFileAPI();
    }

    function checkFileAPI() {
        if (window.File && window.FileReader && window.FileList && window.Blob) {
            reader = new FileReader();
            return true; 
        } else {
            alert('The File APIs are not fully supported by your browser. Fallback required.');
            return false;
        }
    }

    function readInstr(filePath) {
        var fileTypes = ["instr"];
        var output = ""; //placeholder for text output

        if(filePath.files && filePath.files[0]) {           
            reader.onload = function (e) {
                output = e.target.result;
                // FIX: This only checks the first extension...
                var extension = filePath.files[0].name.split('.').pop().toLowerCase(),
                    isSuccess = fileTypes.indexOf(extension) > -1;
                if (isSuccess) {
                    parser.parseContents(output);
                    displayContents("Read File: " + filePath.files[0].name);
                }
            };//end onload()
            console.log("Read Instr File: " + filePath.files[0].name);
            reader.readAsText(filePath.files[0]);
        }//end if html5 filelist support
        else { //this is where you could fallback to Java Applet, Flash or similar
            return false;
        }       
        return true;
    }

    function readAudio(filePath) {
        var fileTypes = ["wav", "aif", "aiff"];
        var audioFileSources = {};
        if(filePath.files && filePath.files[0]) {           
            reader.onload = function (e) {
                // FIX: This only checks the first extension...
                var extension = filePath.files[0].name.split('.').pop().toLowerCase(),
                    isSuccess = fileTypes.indexOf(extension) > -1;
                if (isSuccess) {
                    audioFileSources = loadAudio(filePath.files);
                    var prompt = "Found Audio:\n";
                    for (key in audioFileSources) {
                        prompt += "file: " + key + "\n";
                        prompt += "url: " + audioFileSources[key] + "\n";
                    }
                    var sound = document.getElementById("sound");
                    for (var key in audioFileSources) {
                        sound.src = audioFileSources[key];
                        sound.onend = function(e) {
                            URL.revokeObjectURL(audioFileSources[0]);
                        }
                    }
                    displayContents(prompt);                   
                } 
            };//end onload()
            console.log("Read File: " + filePath.files[0].name);
            reader.readAsText(filePath.files[0]);
        }//end if html5 filelist support
        else { //this is where you could fallback to Java Applet, Flash or similar
            return false;
        }       
        return true;
    }

    /**
     * display content using a basic HTML replacement
     */
    function displayContents(txt) {
        var el = document.getElementById('main'); 
        el.innerHTML = txt; //display output in DOM
    }  

    function loadAudio(filelist) {
        console.log("Loading " + filelist.length + " Audio Files. . .");
        var srcs = {};
        for (var i = 0; i < filelist.length; i++) {
            console.log("Loading " + filelist[i].name);
            srcs[filelist[i].name] = URL.createObjectURL(filelist[i]);
        }
        return srcs;
    }

    
</script>
</head>
<body onload="onPageLoad();">
    <div id="container"> 
        <h2>Instr File Selector</h2>   
        <input type="file" onchange='readInstr(this)'/>
        <br/>
        <hr/>   
        <h2>Audio File Selector</h2>
        <input type="file" onchange='readAudio(this)' multiple/>
        <audio id="sound" controls></audio>
        <br/>
        <hr/>   
        <h2>Controls</h2>
        <p>
        <input type="range" name="size" id="size" step="0.0002" value="0.5"
            min="0.0" max="1.0"> size </p>
        <p>
        <input type="range" name="start" id="start" step="0.0002" value="0.5"
            min="0.0" max="1.0"> start </p>
        <p> 
        <input type="range" name="density" id="density" step="0.0002" value="0.5"
            min="0.0" max="1.0"> density </p>
        <p>
        <input type="range" name="overlap" id="overlap" step="0.0002" value="0.5"
            min="0.0" max="1.0"> overlap </p>
        <p>
        <input type="range" name="blend" id="blend" step="0.0002" value="0.5"
            min="0.0" max="1.0"> blend </p>
        <p>
        <input type="range" name="window" id="window" step="0.0002" value="0.5"
            min="0.0" max="1.0"> window </p>
        <p>
        <input type="range" name="pitch" id="pitch" step="0.0002" value="0.5"
            min="0.0" max="1.0"> pitch </p>
        <p>
        <input type="range" name="speed" id="speed" step="0.0002" value="0.5"
            min="0.0" max="1.0"> speed </p>
        <p>
        <input type="button" name="record" id="record"> record </p>
        <p>
        <input type="button" name="file" id="file"> file </p>
        <p>
        <input type="button" name="source" id="source"> source </p>
        <p>
        <input type="button" name="reset" id="reset"> reset </p>   
        <p>
        <input type="button" name="freeze" id="freeze"> freeze </p>  
        <p>
        <input type="checkbox" name="secondary" id="secondary" value="0"> secondary </p>   
        <br/>
        <hr/>
        <h3>Log:</h3>
        <div id="main">
            ...
        </div>
    </div>
</body>
</html>
